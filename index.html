<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ²ÙƒÙŠØ© | Ø±ÙÙŠÙ‚Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
    
    <!-- ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø³Ø±Ø¹Ø© -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://firestore.googleapis.com">

    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- === ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS (Ù…Ø¯Ù…Ø¬Ø©) === -->
    <style>
        :root {
            --primary: #047857;
            --gold: #D4AF37;
            --bg: #F3F4F6;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø®Ù„ÙÙŠØ© Ø¨Ù†Ù…Ø· Ø®ÙÙŠÙ */
        .bg-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23047857' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        @media (max-width: 640px) {
            body { font-size: 14px; }
            h1 { font-size: 1.5rem; }
            h2 { font-size: 1.25rem; }
            h3 { font-size: 1.1rem; }
            .p-5 { padding: 1rem; }
        }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); transition: opacity 0.2s;
        }
        .modal-content {
            background: white; border-radius: 1.5rem; overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 100%; max-width: 32rem; margin: 1rem;
            transform: scale(1); transition: transform 0.2s;
            max-height: 90vh; display: flex; flex-direction: column;
        }
        @media (max-width: 640px) {
            .modal-content {
                margin: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0;
                position: absolute; bottom: 0; max-width: 100%; max-height: 85vh;
                animation: slideUp 0.3s ease-out;
            }
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Custom Checkbox */
        .task-checkbox {
            appearance: none; width: 1.5rem; height: 1.5rem;
            border: 2px solid #D1D5DB; border-radius: 0.5rem;
            display: grid; place-content: center; cursor: pointer;
            transition: all 0.2s; background: white;
        }
        .task-checkbox::before {
            content: ""; width: 0.8rem; height: 0.8rem; transform: scale(0);
            background-color: white; box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
            transition: 0.2s transform ease-in-out;
        }
        .task-checkbox:checked { background-color: var(--primary); border-color: var(--primary); }
        .task-checkbox:checked::before { transform: scale(1); }

        .click-anim:active { transform: scale(0.95); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #047857; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 overflow-hidden relative">

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-green-100 border-t-[#047857] rounded-full animate-spin"></div>
        <p class="mt-4 text-xs text-gray-400 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</p>
    </div>

    <!-- 1. Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© -->
    <section id="landing-screen" class="absolute inset-0 bg-white z-40 overflow-y-auto hidden">
        <nav class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="moon" class="text-yellow-500 w-6 h-6 fill-current"></i>
                <h1 class="text-xl font-bold text-[#047857]">ØªØ²ÙƒÙŠØ©</h1>
            </div>
            <button onclick="goToAuth('login')" class="px-5 py-2 bg-[#047857] text-white font-bold rounded-xl text-sm shadow-md transition-all">Ø¯Ø®ÙˆÙ„</button>
        </nav>
        <main class="flex flex-col items-center justify-center text-center px-4 mt-16 pb-20">
            <h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-4 leading-tight">
                Ø£ØµÙ„Ø­ Ù‚Ù„Ø¨ÙƒØŒ <br><span class="text-[#047857]">ÙŠØµÙ„Ø­ Ø§Ù„Ù„Ù‡ Ø­Ø§Ù„Ùƒ</span>
            </h1>
            <p class="text-gray-500 max-w-lg mx-auto mb-8 text-sm md:text-base">
                Ø±ÙÙŠÙ‚Ùƒ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØµÙ„ÙˆØ§ØªØŒ Ø§Ù„Ø£Ø°ÙƒØ§Ø±ØŒ ÙˆØ§Ù„ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ.
            </p>
            <button onclick="goToAuth('register')" class="px-8 py-3.5 bg-[#047857] text-white text-base font-bold rounded-xl shadow-xl hover:shadow-2xl transition-all flex items-center gap-2">
                Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¢Ù† <i data-lucide="arrow-left" class="w-4 h-4"></i>
            </button>
        </main>
    </section>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ -->
    <section id="auth-screen" class="hidden absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-4">
        <button onclick="showLandingScreen()" class="absolute top-6 right-6 text-gray-400 hover:text-[#047857] flex items-center gap-1 font-bold text-sm"><i data-lucide="arrow-right" class="w-4 h-4"></i> Ø±Ø¬ÙˆØ¹</button>
        <div class="w-full max-w-sm">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ğŸŒ¿</h2>
                <p class="text-gray-500 text-xs mt-1">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
            </div>
            <div id="auth-tabs" class="bg-gray-100 p-1 rounded-xl flex mb-6">
                <button onclick="switchAuthMode('login')" id="tab-login" class="flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-white text-[#047857] shadow-sm">Ø¯Ø®ÙˆÙ„</button>
                <button onclick="switchAuthMode('register')" id="tab-register" class="flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all">Ø¬Ø¯ÙŠØ¯</button>
            </div>
            <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-[#047857] outline-none text-sm">
                <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-[#047857] outline-none text-sm">
                <div class="flex justify-end"><button type="button" onclick="switchAuthMode('reset')" class="text-xs font-bold text-[#047857]">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button></div>
                <button type="submit" class="w-full py-3.5 rounded-xl shadow-lg text-white bg-[#047857] font-bold text-sm transition-all">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </form>
            <form id="register-form" class="space-y-4 hidden" onsubmit="handleRegister(event)">
                <input type="text" id="reg-name" placeholder="Ø§Ù„Ø§Ø³Ù…" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-[#047857] outline-none text-sm">
                <input type="email" id="reg-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-[#047857] outline-none text-sm">
                <input type="password" id="reg-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-[#047857] outline-none text-sm">
                <button type="submit" class="w-full py-3.5 rounded-xl shadow-lg text-white bg-[#047857] font-bold text-sm transition-all">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
            </form>
            <form id="reset-form" class="space-y-4 hidden" onsubmit="handleResetPassword(event)">
                <p class="text-xs text-center text-gray-500 mb-2">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
                <input type="email" id="reset-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:border-[#047857] outline-none text-sm">
                <button type="submit" class="w-full py-3.5 rounded-xl shadow-lg text-white bg-blue-600 font-bold text-sm transition-all">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                <button type="button" onclick="switchAuthMode('login')" class="w-full py-2 text-gray-500 font-bold text-xs">Ø¥Ù„ØºØ§Ø¡</button>
            </form>
        </div>
    </section>

    <!-- 3. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="app-screen" class="hidden flex h-screen bg-[#F3F4F6] overflow-hidden">
        <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (PC) -->
        <aside class="w-64 bg-white hidden md:flex flex-col border-l border-gray-100 shadow-sm z-20">
            <div class="h-20 flex items-center justify-center border-b border-gray-50">
                <h1 class="text-2xl font-bold text-[#047857] flex gap-2 items-center"><i data-lucide="moon" class="text-yellow-500 fill-current"></i> ØªØ²ÙƒÙŠØ©</h1>
            </div>
            <div class="flex-1 p-4 space-y-2 overflow-y-auto" id="sidebar-content"></div>
            <div class="p-4 border-t border-gray-50">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-[#047857] text-white flex items-center justify-center font-bold text-lg" id="user-avatar">Ù…</div>
                    <div class="overflow-hidden">
                        <p class="text-sm font-bold text-gray-800 truncate" id="user-name-display">...</p>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-full py-2 border border-red-100 text-red-500 rounded-lg hover:bg-red-50 text-sm font-bold flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Ø®Ø±ÙˆØ¬</button>
            </div>
        </aside>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <main class="flex-1 flex flex-col h-full relative overflow-hidden">
            <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ -->
            <header class="md:hidden h-16 bg-white/90 backdrop-blur-md border-b border-gray-100 flex items-center justify-between px-4 z-10 shrink-0 sticky top-0">
                <span class="font-bold text-lg text-[#047857]">ØªØ²ÙƒÙŠØ©</span>
                <div class="flex gap-2">
                    <button onclick="openPrayerSettingsModal()" class="p-2 bg-gray-50 text-gray-600 rounded-lg"><i data-lucide="map-pin" class="w-4 h-4"></i></button>
                    <button onclick="handleLogout()" class="p-2 bg-red-50 text-red-500 rounded-lg"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 pb-28 scroll-smooth">
                <!-- Ø§Ù„ØªØ­ÙŠØ© -->
                <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-3">
                    <div>
                        <h2 class="text-xl md:text-2xl font-bold text-gray-800">Ø£Ù‡Ù„Ø§Ù‹ØŒ <span id="welcome-name" class="text-[#047857]">...</span> ğŸ‘‹</h2>
                        <div class="flex items-center gap-2 mt-1">
                             <p class="text-xs text-gray-500" id="motivational-text">ÙƒÙŠÙ Ù‡ÙŠ Ù‡Ù…ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ</p>
                        </div>
                    </div>
                    <div class="flex gap-2 items-center bg-white p-1 rounded-lg shadow-sm border border-gray-100 self-end md:self-auto">
                        <button onclick="changeDate(-1)" class="p-1.5 hover:bg-gray-100 rounded text-gray-600"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        <div class="px-3 py-1 text-xs font-bold min-w-[100px] text-center"><span id="current-date-display">...</span></div>
                        <button onclick="changeDate(1)" id="btn-next-day" class="p-1.5 hover:bg-gray-100 rounded text-gray-600"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    </div>
                </div>

                <!-- Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª + Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <!-- ÙƒØ§Ø±Øª Ø§Ù„Ù†Ø³Ø¨Ø© -->
                    <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 lg:col-span-1 flex flex-col items-center justify-center relative min-h-[140px]">
                        <div class="relative w-32 h-32">
                            <canvas id="performanceChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center flex-col">
                                <span class="text-xl font-bold text-gray-800" id="chart-percent">0%</span>
                                <span class="text-[10px] text-gray-400">Ø¥Ù†Ø¬Ø§Ø²</span>
                            </div>
                        </div>
                    </div>
                    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© -->
                    <div class="bg-gradient-to-br from-[#047857] to-[#064E3B] p-5 rounded-2xl shadow-lg text-white relative overflow-hidden lg:col-span-2 flex flex-col justify-between">
                         <div class="flex justify-between items-start">
                             <div>
                                 <p class="text-green-100 text-xs font-bold mb-1">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</p>
                                 <h3 id="next-prayer-name" class="text-2xl font-bold">...</h3>
                             </div>
                             <div class="text-left">
                                 <p id="next-prayer-time" class="text-3xl font-bold font-mono">--:--</p>
                                 <button onclick="openPrayerSettingsModal()" class="text-[10px] text-green-200 flex items-center gap-1 mt-1 hover:text-white"><i data-lucide="settings" class="w-3 h-3"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø°Ø§Ù†</button>
                             </div>
                         </div>
                         <div id="prayer-timeline" class="flex justify-between mt-4 text-[10px] text-green-200 pt-4 border-t border-green-700/50">
                             <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦ØªÙ‡ Ø¨ÙˆØ§Ø³Ø·Ø© JS -->
                         </div>
                    </div>
                </div>

                <!-- Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø°ÙƒØ§Ø± -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2"><div class="w-1 h-5 bg-blue-600 rounded-full"></div><h3 class="text-lg font-bold text-gray-800">Ø§Ù„Ø£Ø°ÙƒØ§Ø± ğŸ“¿</h3></div>
                        <button onclick="openModal('adhkar-modal')" id="btn-add-dhikr" class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-bold flex items-center gap-1"><i data-lucide="plus" class="w-3 h-3"></i> Ø¥Ø¶Ø§ÙØ©</button>
                    </div>
                    <div id="adhkar-container" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>

                <!-- Ø§Ù„Ù…Ù‡Ø§Ù… (Ø§Ù„ØµÙ„ÙˆØ§Øª ÙˆØ§Ù„Ø³Ù†Ù†) -->
                <div id="tasks-container" class="space-y-6"></div>
            </div>
        </main>
    </div>

    <!-- === Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) === -->
    
    <!-- Ø¥Ø¶Ø§ÙØ© Ø°ÙƒØ± -->
    <div id="adhkar-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeModal('adhkar-modal')">
        <div class="modal-content max-w-xs p-5">
            <h3 class="text-lg font-bold text-gray-800 mb-3">Ø°ÙƒØ± Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="new-dhikr-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø°ÙƒØ±" class="w-full p-2.5 bg-gray-50 rounded-lg border border-gray-200 mb-3 text-sm outline-none focus:border-blue-500">
            <input type="number" id="new-dhikr-target" placeholder="Ø§Ù„Ù‡Ø¯Ù (Ù…Ø«Ù„Ø§Ù‹ 100)" class="w-full p-2.5 bg-gray-50 rounded-lg border border-gray-200 mb-4 text-sm outline-none focus:border-blue-500">
            <button onclick="addNewDhikr()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm">Ø¥Ø¶Ø§ÙØ©</button>
        </div>
    </div>

    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹ -->
    <div id="manual-count-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeModal('manual-count-modal')">
        <div class="modal-content max-w-xs p-5">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø¯</h3>
            <input type="number" id="manual-count-input" class="w-full p-3 bg-gray-50 rounded-lg border border-gray-200 mb-4 text-center text-xl font-bold outline-none focus:border-blue-500">
            <button onclick="saveManualCount()" class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-bold text-sm">Ø­ÙØ¸</button>
        </div>
    </div>

    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ -->
    <div id="prayer-settings-modal" class="modal-overlay hidden" onclick="if(event.target === this) closeModal('prayer-settings-modal')">
        <div class="modal-content">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-[#047857]">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ø£Ø°Ø§Ù†</h3><button onclick="closeModal('prayer-settings-modal')"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="p-4 space-y-4">
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center gap-2">
                        <i data-lucide="volume-2" class="w-5 h-5 text-gray-500"></i>
                        <span class="text-sm font-bold">ØªÙØ¹ÙŠÙ„ ØµÙˆØª Ø§Ù„Ø£Ø°Ø§Ù†</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-adhan-sound" class="sr-only peer" onchange="saveAdhanSettings()">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#047857]"></div>
                    </label>
                </div>

                <div class="p-3 bg-gray-50 rounded-lg">
                    <label class="text-xs font-bold text-gray-500 block mb-2">Ø·Ø±ÙŠÙ‚Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª (Ø­Ø³Ø¨ Ø§Ù„Ø¨Ù„Ø¯)</label>
                    <select id="calculation-method" class="w-full p-2 rounded border text-sm" onchange="saveAdhanSettings()">
                        <option value="5">Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø­Ø© (Ù…ØµØ±)</option>
                        <option value="4">Ø¬Ø§Ù…Ø¹Ø© Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ (Ù…ÙƒØ© Ø§Ù„Ù…ÙƒØ±Ù…Ø©)</option>
                        <option value="2">Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ù„Ø£Ù…Ø±ÙŠÙƒØ§ Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©</option>
                        <option value="3">Ø±Ø§Ø¨Ø·Ø© Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</option>
                        <option value="1">Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ø¨ÙƒØ±Ø§ØªØ´ÙŠ</option>
                        <option value="12">ÙØ±Ù†Ø³Ø§ - UOIF</option>
                        <option value="13">ØªØ±ÙƒÙŠØ§ - Diyanet</option>
                        <option value="0">Ø§Ù„Ù…Ø°Ù‡Ø¨ Ø§Ù„Ø¬Ø¹ÙØ±ÙŠ</option>
                    </select>
                </div>
                
                <div class="text-xs text-gray-400 text-center mt-2">
                    ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ GPS Ù‡Ø§ØªÙÙƒ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©.
                </div>
            </div>
            <div class="p-4 border-t"><button onclick="closeModal('prayer-settings-modal')" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold">Ø¥ØºÙ„Ø§Ù‚</button></div>
        </div>
    </div>

    <!-- === Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ (JS) === -->
    <script>
        // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ ===
        const firebaseConfig = {
            apiKey: "AIzaSyDr1bE57IpBPNz0qCCgb-RxLqsnJ0qPrUw",
            authDomain: "tazkiah-app-33b52.firebaseapp.com",
            projectId: "tazkiah-app-33b52",
            storageBucket: "tazkiah-app-33b52.firebasestorage.app",
            messagingSenderId: "578639643202",
            appId: "1:578639643202:web:f292b2b18cc9fdcf8f63db",
            measurementId: "G-T97YMH1YL3"
        };

        let auth, db;
        let currentUser = null;
        let unsubscribeSnapshot = null;
        let performanceChartInstance = null;
        let reportChartInstance = null;
        let lastUserData = null; 
        let currentDate = new Date();

        let prayerTimes = null; 
        let adhanAudio = new Audio('https://www.islamcan.com/audio/adhan/azan2.mp3'); 
        let adhanSettings = { enabled: true, method: 5 }; // 5: Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ù…ØµØ±ÙŠØ© (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)
        let currentAdhkarEditIndex = null; 
        let openModalsStack = []; // Ù„Ø¥Ø¯Ø§Ø±Ø© Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„

        // === Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ===
        let quranAudio = new Audio();
        let currentSurahAyahs = [];
        let currentAyahIndex = 0;
        let verseRepeatCount = 1;
        let currentVerseRepeat = 0;
        let isPlaying = false;
        let currentReciterId = "ar.yasseraldossari";

        const RECITERS = {
            "ar.yasseraldossari": "ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ",
            "ar.alafasy": "Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ",
            "ar.husary": "Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ",
            "ar.minshawi": "Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ",
            "ar.abdulbasit": "Ø¹Ø¨Ø¯ Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯ Ø§Ù„ØµÙ…Ø¯",
            "ar.mahermuaiqly": "Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ"
        };

        const HABITS_META = {
            rawatib: { name: 'Ø§Ù„Ø³Ù†Ù† (12)', icon: 'layers' },
            duha: { name: 'Ø§Ù„Ø¶Ø­Ù‰', icon: 'sun' },
            witr: { name: 'Ø§Ù„ÙˆØªØ±', icon: 'moon' },
            azkar_m: { name: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„ØµØ¨Ø§Ø­', icon: 'sunrise' },
            azkar_e: { name: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù…Ø³Ø§Ø¡', icon: 'sunset' },
            azkar_s: { name: 'Ø£Ø°ÙƒØ§Ø± Ø§Ù„Ù†ÙˆÙ…', icon: 'star' },
            fasting_mon: { name: 'ØµÙŠØ§Ù… Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', icon: 'calendar' },
            fasting_thu: { name: 'ØµÙŠØ§Ù… Ø§Ù„Ø®Ù…ÙŠØ³', icon: 'calendar' }
        };

        const DEFAULT_USER_DATA = {
            prayers: { fajr: false, dhuhr: false, asr: false, maghrib: false, isha: false },
            quran: false,
            habits: { rawatib: false, duha: false, witr: false, azkar_m: false, azkar_e: false, azkar_s: false },
            habitSettings: { rawatib: true, duha: true, witr: true, azkar_m: true, azkar_e: true, azkar_s: true },
            customAdhkar: [] 
        };

        // === Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ ===
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            initApp();
            handleBrowserHistory(); // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù…ÙˆØ¯Ø§Ù„
        });

        function initApp() {
            if (typeof firebase === 'undefined') return;
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            
            // ØªÙØ¹ÙŠÙ„ Offline Persistence (Ù„Ù„Ø³Ø±Ø¹Ø©)
            if(firebase.firestore) {
                db = firebase.firestore();
                db.enablePersistence({ synchronizeTabs: true }).catch(err => console.log("Persistence disabled:", err.code));
            }
            
            auth = firebase.auth();

            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = user;
                    showScreen('app-screen');
                    currentDate = new Date();
                    
                    // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø°Ø§Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                    await loadAdhanSettings();
                    
                    loadUserDataForDate(currentDate);
                    injectSettingsUI(); 
                    injectMobileNav(); 
                    initPrayerTimes(); 
                    injectQuranModal();
                    injectReportModal(); 
                    requestNotificationPermission(); 
                    
                    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙŠØ¯Ø±
                    document.getElementById('user-name-display').innerText = user.displayName || user.email;
                    document.getElementById('user-avatar').innerText = (user.displayName || user.email)[0].toUpperCase();
                    document.getElementById('welcome-name').innerText = (user.displayName || user.email).split(' ')[0];

                } else {
                    currentUser = null;
                    showScreen('landing-screen');
                }
                hideLoader();
            });
        }

        // === ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù‡Ø§ØªÙ (Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹) ===
        function handleBrowserHistory() {
            window.onpopstate = (event) => {
                if (openModalsStack.length > 0) {
                    const modalId = openModalsStack.pop();
                    document.getElementById(modalId).classList.add('hidden');
                    // Ù…Ù†Ø¹ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙ‚Ø· Ù†ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
                    // history.pushState(null, null, window.location.href); 
                }
            };
        }

        function openModal(modalId) {
            const el = document.getElementById(modalId);
            if(el) {
                el.classList.remove('hidden');
                openModalsStack.push(modalId);
                history.pushState({modal: modalId}, null, "");
            }
        }

        function closeModal(modalId) {
            const el = document.getElementById(modalId);
            if(el) {
                el.classList.add('hidden');
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù‡Ùˆ Ø¢Ø®Ø± ÙˆØ§Ø­Ø¯ ÙÙŠ Ø§Ù„Ø³ØªØ§ÙƒØŒ Ù†Ø²ÙŠÙ„Ù‡
                if (openModalsStack.length > 0 && openModalsStack[openModalsStack.length - 1] === modalId) {
                    openModalsStack.pop();
                    history.back(); // Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
                }
            }
        }

        // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø°Ø§Ù† ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ù†ÙØµÙ„Ø©) ===
        function openPrayerSettingsModal() {
            // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            document.getElementById('toggle-adhan-sound').checked = adhanSettings.enabled;
            document.getElementById('calculation-method').value = adhanSettings.method;
            openModal('prayer-settings-modal');
        }

        async function loadAdhanSettings() {
            if(!currentUser) return;
            try {
                const doc = await db.collection('users').doc(currentUser.uid).get();
                if(doc.exists && doc.data().adhanSettings) {
                    adhanSettings = doc.data().adhanSettings;
                }
            } catch(e) { console.error("Error loading settings", e); }
        }

        async function saveAdhanSettings() {
            const enabled = document.getElementById('toggle-adhan-sound').checked;
            const method = parseInt(document.getElementById('calculation-method').value);
            
            adhanSettings = { enabled, method };
            
            if(currentUser) {
                await db.collection('users').doc(currentUser.uid).set({ adhanSettings }, { merge: true });
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            initPrayerTimes();
        }

        // === Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© (Ù…Ø­Ø¯Ø«Ø© Ù„ØªØ£Ø®Ø° Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©) ===
        function initPrayerTimes() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    fetchPrayerTimes(pos.coords.latitude, pos.coords.longitude);
                }, () => fetchPrayerTimes(30.0444, 31.2357)); // Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            } else {
                fetchPrayerTimes(30.0444, 31.2357);
            }
            setInterval(checkTimeForAlerts, 60000);
        }

        async function fetchPrayerTimes(lat, lng) {
            const date = new Date();
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
            const method = adhanSettings.method || 5; 
            const url = `https://api.aladhan.com/v1/timings/${date.getDate()}-${date.getMonth()+1}-${date.getFullYear()}?latitude=${lat}&longitude=${lng}&method=${method}`;
            
            try {
                const res = await fetch(url);
                const data = await res.json();
                if(data.code === 200) {
                    prayerTimes = data.data.timings;
                    updatePrayerUI();
                }
            } catch (e) { console.error(e); }
        }

        function updatePrayerUI() {
            if (!prayerTimes) return;
            const mapping = { fajr: 'Fajr', dhuhr: 'Dhuhr', asr: 'Asr', maghrib: 'Maghrib', isha: 'Isha' };
            const arNames = { fajr: 'Ø§Ù„ÙØ¬Ø±', dhuhr: 'Ø§Ù„Ø¸Ù‡Ø±', asr: 'Ø§Ù„Ø¹ØµØ±', maghrib: 'Ø§Ù„Ù…ØºØ±Ø¨', isha: 'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
            
            // Timeline Container
            const tl = document.getElementById('prayer-timeline');
            if(tl) tl.innerHTML = '';
            
            let nextPrayer = null;
            let minDiff = Infinity;
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            for (const [key, apiName] of Object.entries(mapping)) {
                const time = prayerTimes[apiName];
                if(!time) continue;
                const [h, m] = time.split(':');
                let hours = parseInt(h);
                const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
                const displayH = hours % 12 || 12; 
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ÙƒØ±ÙˆØª
                const el = document.getElementById(`time-${key}`);
                if(el) el.innerText = `${displayH}:${m} ${ampm}`;

                // Timeline
                if(tl) tl.innerHTML += `<div><span>${arNames[key]}</span><br>${displayH}:${m}</div>`;

                // Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
                const prayerMinutes = parseInt(h) * 60 + parseInt(m);
                let diff = prayerMinutes - currentMinutes;
                if (diff < 0) diff += 24 * 60; // Ù„Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ØºØ¯Ø§Ù‹
                
                if (diff < minDiff) {
                    minDiff = diff;
                    nextPrayer = { name: arNames[key], time: `${displayH}:${m} ${ampm}` };
                }
            }

            if(nextPrayer) {
                document.getElementById('next-prayer-name').innerText = nextPrayer.name;
                document.getElementById('next-prayer-time').innerText = nextPrayer.time;
            }
        }

        function checkTimeForAlerts() {
            if(!prayerTimes || !adhanSettings.enabled) return;
            const now = new Date();
            const currentH = now.getHours();
            const currentM = now.getMinutes();
            
            ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'].forEach(p => {
                const [h, m] = prayerTimes[p].split(':');
                if (parseInt(h) === currentH && parseInt(m) === currentM) playAdhan(p);
            });
        }

        function playAdhan(name) {
            adhanAudio.play().catch(()=>{});
            if (Notification.permission === "granted") new Notification(`ğŸ“¢ Ø­Ø§Ù† Ù…ÙˆØ¹Ø¯ ${name}`);
        }

        // === Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ… ===
        function injectQuranModal() {
            if (document.getElementById('quran-modal')) return;
            const modal = document.createElement('div');
            modal.id = 'quran-modal';
            modal.className = 'modal-overlay hidden';
            // modal.onclick handled by handleBrowserHistory logic mostly, but explicit click too:
            modal.onclick = (e) => { if(e.target === modal) closeModal('quran-modal'); };
            
            let options = '';
            for (const [k, v] of Object.entries(RECITERS)) options += `<option value="${k}">${v}</option>`;

            modal.innerHTML = `
                <div class="modal-content h-[90vh] flex flex-col">
                    <div class="p-3 border-b bg-gray-50 flex gap-2 items-center justify-between">
                        <div class="flex gap-2 items-center flex-1">
                            <select id="surah-select" class="p-2 rounded border text-xs flex-1" onchange="loadSurah(this.value)">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©...</option>
                            </select>
                        </div>
                        <div class="flex gap-2 items-center">
                            <select id="reciter-select" class="p-2 rounded border text-xs w-24" onchange="currentReciterId=this.value; if(currentSurahAyahs.length) playVerse(currentAyahIndex);">${options}</select>
                            <button onclick="closeModal('quran-modal')" class="text-gray-500 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div id="quran-content" class="flex-1 overflow-y-auto p-4 text-center bg-white text-lg leading-loose font-serif">
                        <div class="flex flex-col items-center justify-center h-full text-gray-400"><i data-lucide="book" class="w-12 h-12 mb-2"></i><p>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙˆØ±Ø©</p></div>
                    </div>
                    <div id="audio-player-bar" class="p-3 border-t bg-gray-50 flex justify-between items-center hidden">
                        <div class="text-[10px] text-gray-500"><span id="player-status">...</span></div>
                        <div class="flex gap-4">
                            <button onclick="prevVerse()"><i data-lucide="skip-back" class="w-5 h-5"></i></button>
                            <button onclick="togglePlay()" id="play-btn" class="w-10 h-10 bg-[#047857] text-white rounded-full flex items-center justify-center"><i data-lucide="play" class="w-5 h-5"></i></button>
                            <button onclick="nextVerse()"><i data-lucide="skip-forward" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙˆØ±
            fetch('https://api.alquran.cloud/v1/surah').then(r=>r.json()).then(d => {
                const sel = document.getElementById('surah-select');
                d.data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.number; opt.text = `${s.number}. ${s.name}`;
                    sel.appendChild(opt);
                });
            });

            quranAudio.addEventListener('ended', () => {
                if(currentVerseRepeat < verseRepeatCount - 1) {
                    currentVerseRepeat++; quranAudio.currentTime = 0; quranAudio.play();
                } else {
                    currentVerseRepeat = 0;
                    if(currentAyahIndex < currentSurahAyahs.length - 1) playVerse(currentAyahIndex + 1);
                    else { isPlaying = false; updatePlayIcon(); }
                }
            });
        }

        async function loadSurah(num) {
            if(!num) return;
            const div = document.getElementById('quran-content');
            div.innerHTML = '<div class="text-center mt-10">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/surah/${num}/${currentReciterId}`);
                const data = await res.json();
                currentSurahAyahs = data.data.ayahs;
                currentAyahIndex = 0;
                let html = `<div class="max-w-2xl mx-auto text-justify" style="direction: rtl;">`;
                if(num!=1 && num!=9) html += `<div class="text-center mb-4 text-sm text-gray-500">Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡ Ø§Ù„Ø±Ø­Ù…Ù† Ø§Ù„Ø±Ø­ÙŠÙ…</div>`;
                currentSurahAyahs.forEach((a, i) => {
                    const txt = a.text.replace('Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„Ù‘ÙÙ‡Ù Ù±Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù', '').trim();
                    html += `<span id="ayah-${i}" class="cursor-pointer hover:text-green-600 transition-colors" onclick="playVerse(${i})">${txt} <span class="text-green-600 text-sm">(${a.numberInSurah})</span> </span>`;
                });
                html += `</div>`;
                div.innerHTML = html;
                document.getElementById('audio-player-bar').classList.remove('hidden');
            } catch(e) { div.innerHTML = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„'; }
        }

        function playVerse(i) {
            if(i < 0 || i >= currentSurahAyahs.length) return;
            currentAyahIndex = i;
            const a = currentSurahAyahs[i];
            const url = a.audio || (a.audioSecondary ? a.audioSecondary[0] : null);
            if(url) {
                quranAudio.src = url;
                quranAudio.play();
                isPlaying = true;
                updatePlayIcon();
                document.querySelectorAll('#quran-content span').forEach(s => s.classList.remove('bg-green-100'));
                const el = document.getElementById(`ayah-${i}`);
                if(el) {
                    el.classList.add('bg-green-100');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                document.getElementById('player-status').innerText = `Ø§Ù„Ø¢ÙŠØ© ${a.numberInSurah}`;
            }
        }
        function togglePlay() { if(isPlaying) quranAudio.pause(); else quranAudio.play(); isPlaying = !isPlaying; updatePlayIcon(); }
        function updatePlayIcon() { const i = document.querySelector('#play-btn i'); if(i) i.setAttribute('data-lucide', isPlaying ? 'pause' : 'play'); lucide.createIcons(); }
        function nextVerse() { playVerse(currentAyahIndex + 1); }
        function prevVerse() { playVerse(currentAyahIndex - 1); }

        // === ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===
        function injectMobileNav() {
            if (document.getElementById('mobile-bottom-nav')) return;
            const nav = document.createElement('div');
            nav.id = 'mobile-bottom-nav';
            nav.className = 'md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-50 flex justify-around items-center h-16';
            nav.innerHTML = `
                <button onclick="showScreen('app-screen')" class="flex flex-col items-center w-full text-[#047857]"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="text-[9px] mt-1">ÙŠÙˆÙ…ÙŠØªÙŠ</span></button>
                <button onclick="openModal('quran-modal')" class="flex flex-col items-center w-full text-gray-500 hover:text-[#047857]"><i data-lucide="book-open" class="w-5 h-5"></i><span class="text-[9px] mt-1">Ø§Ù„Ù…ØµØ­Ù</span></button>
                <button onclick="openReportModal()" class="flex flex-col items-center w-full text-gray-500 hover:text-[#047857]"><i data-lucide="bar-chart-2" class="w-5 h-5"></i><span class="text-[9px] mt-1">ØªÙ‚Ø§Ø±ÙŠØ±</span></button>
                <button onclick="openSettingsModal()" class="flex flex-col items-center w-full text-gray-500 hover:text-[#047857]"><i data-lucide="sliders" class="w-5 h-5"></i><span class="text-[9px] mt-1">ØªØ®ØµÙŠØµ</span></button>`;
            document.body.appendChild(nav);
            lucide.createIcons();
        }

        function injectSettingsUI() {
            const sidebar = document.getElementById('sidebar-content');
            if (sidebar && !document.getElementById('btn-settings-pc')) {
                sidebar.innerHTML += `
                    <button onclick="openSettingsModal()" id="btn-settings-pc" class="w-full flex items-center gap-4 px-6 py-4 text-gray-600 hover:bg-gray-50 hover:text-[#047857] rounded-l-2xl font-bold transition-all"><i data-lucide="sliders"></i> ØªØ®ØµÙŠØµ Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª</button>
                `;
                lucide.createIcons();
            }
            
            if (!document.getElementById('settings-modal')) {
                const div = document.createElement('div');
                div.id = 'settings-modal';
                div.className = 'modal-overlay hidden';
                div.onclick = (e) => { if(e.target === div) closeModal('settings-modal'); };
                div.innerHTML = `
                    <div class="modal-content">
                        <div class="p-4 border-b bg-gray-50 flex justify-between items-center"><h3 class="font-bold">ØªØ®ØµÙŠØµ Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª</h3><button onclick="closeModal('settings-modal')"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                        <div class="p-4 overflow-y-auto max-h-[60vh]" id="settings-list"></div>
                        <div class="p-4 border-t"><button onclick="saveSettings()" class="w-full bg-[#047857] text-white py-2 rounded-lg font-bold">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button></div>
                    </div>`;
                document.body.appendChild(div);
            }
        }

        // === Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ù…Ø­Ø³Ù†Ø© - Real Data) ===
        function injectReportModal() {
            if (document.getElementById('report-modal')) return;
            const div = document.createElement('div');
            div.id = 'report-modal';
            div.className = 'modal-overlay hidden';
            div.onclick = (e) => { if(e.target === div) closeModal('report-modal'); };
            
            div.innerHTML = `
                <div class="modal-content max-w-4xl h-[90vh] flex-col md:flex-row">
                    <div class="w-full md:w-1/3 bg-gray-50 p-4 border-l overflow-y-auto">
                        <h3 class="font-bold mb-4 text-center">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
                        <div class="flex bg-gray-200 p-1 rounded-lg mb-4 text-xs">
                            <button onclick="generateReport('day')" class="flex-1 py-1.5 rounded bg-white shadow-sm font-bold text-[#047857]">ÙŠÙˆÙ…ÙŠ</button>
                            <button onclick="generateReport('week')" class="flex-1 py-1.5 rounded text-gray-600">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                            <button onclick="generateReport('month')" class="flex-1 py-1.5 rounded text-gray-600">Ø´Ù‡Ø±ÙŠ</button>
                        </div>
                        <div class="space-y-2">
                            <button onclick="downloadAsPDF()" class="w-full py-2 border rounded-lg text-xs flex items-center justify-center gap-2 hover:bg-white"><i data-lucide="file-text" class="w-3 h-3"></i> ØªØ­Ù…ÙŠÙ„ PDF</button>
                        </div>
                    </div>
                    <div class="w-full md:w-2/3 p-4 overflow-y-auto bg-gray-100 flex justify-center">
                        <div id="report-preview-content" class="bg-white p-6 shadow-lg w-full max-w-md relative min-h-[500px]">
                            <div class="text-center border-b pb-4 mb-4">
                                <h2 class="text-xl font-bold text-[#047857]" id="rep-title">ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø²</h2>
                                <p class="text-xs text-gray-500" id="rep-date">...</p>
                            </div>
                            <div class="flex justify-around mb-6 text-center">
                                <div><p class="text-xs text-gray-400">Ø¥Ù†Ø¬Ø§Ø²</p><p class="text-2xl font-bold text-[#047857]" id="rep-percent">0%</p></div>
                                <div><p class="text-xs text-gray-400">Ø£Ø°ÙƒØ§Ø±</p><p class="text-2xl font-bold text-blue-600" id="rep-adhkar">0</p></div>
                            </div>
                            <div class="h-40 mb-4" id="rep-chart-container"><canvas id="reportChart"></canvas></div>
                            <ul class="text-xs space-y-2" id="rep-list"></ul>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(div);
            lucide.createIcons();
        }

        function openReportModal() {
            openModal('report-modal');
            generateReport('day');
        }

        async function generateReport(period) {
            const title = document.getElementById('rep-title');
            const date = document.getElementById('rep-date');
            const percent = document.getElementById('rep-percent');
            const list = document.getElementById('rep-list');
            
            if (reportChartInstance) { reportChartInstance.destroy(); reportChartInstance = null; }
            
            if (period === 'day') {
                title.innerText = "ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ";
                date.innerText = getReadableDate(currentDate);
                if(lastUserData) {
                    percent.innerText = document.getElementById('chart-percent').innerText;
                    const adhkCount = document.getElementById('total-adhkar-count')?.innerText || '0';
                    document.getElementById('rep-adhkar').innerText = adhkCount;
                    
                    list.innerHTML = '';
                    for(const [k,v] of Object.entries(lastUserData.prayers)) if(v) list.innerHTML += `<li class="text-green-700">âœ… ØµÙ„Ø§Ø© ${k}</li>`;
                    
                    const p = parseInt(percent.innerText);
                    const ctx = document.getElementById('reportChart');
                    reportChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: ['ØªÙ…', 'Ø¨Ø§Ù‚ÙŠ'], datasets: [{ data: [p, 100-p], backgroundColor: ['#047857', '#eee'] }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                    });
                }
            } else {
                const days = period === 'week' ? 7 : 30;
                title.innerText = period === 'week' ? "ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ" : "ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ";
                date.innerText = `Ø¢Ø®Ø± ${days} ÙŠÙˆÙ…`;
                
                // Ø¥Ø¸Ù‡Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ·
                list.innerHTML = '<li class="text-gray-500 text-center">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</li>';
                
                const stats = await fetchAggregateData(days);
                percent.innerText = stats.percent + "%";
                document.getElementById('rep-adhkar').innerText = stats.totalAdhkar;
                list.innerHTML = `<li class="text-gray-600">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡: ${stats.percent}%</li><li class="text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø°ÙƒØ§Ø±: ${stats.totalAdhkar}</li>`;
                
                const ctx = document.getElementById('reportChart');
                reportChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: stats.history.map(h => h.label),
                        datasets: [{ label: 'Ø¥Ù†Ø¬Ø§Ø²', data: stats.history.map(h => h.val), backgroundColor: '#047857' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } } }
                });
            }
        }

        async function fetchAggregateData(days) {
            let totalP = 0; let totalA = 0; let count = 0; const hist = [];
            const d = new Date();
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Promise.all Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø³Ø±Ø¹Ø©
            const promises = [];
            const dateLabels = [];

            for(let i=days-1; i>=0; i--) {
                const tempD = new Date(); tempD.setDate(d.getDate() - i);
                const did = getFormattedDateID(tempD);
                dateLabels.push(tempD.getDate());
                promises.push(db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did).get());
            }

            const docs = await Promise.all(promises);

            docs.forEach((doc, index) => {
                let val = 0;
                if(doc.exists) {
                    const da = doc.data();
                    let done=0, tot=0;
                    if(da.prayers) Object.values(da.prayers).forEach(v=>{tot++; if(v) done++});
                    if(da.customAdhkar) da.customAdhkar.forEach(a=> totalA += (a.count||0));
                    val = tot>0 ? Math.round((done/tot)*100) : 0;
                    totalP += val; 
                    count++;
                }
                hist.push({ label: dateLabels[index], val });
            });

            return { percent: count ? Math.round(totalP/count) : 0, totalAdhkar: totalA, history: hist };
        }

        function downloadAsPDF() {
            const { jsPDF } = window.jspdf;
            const content = document.getElementById('report-preview-content');
            html2canvas(content).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const width = pdf.internal.pageSize.getWidth();
                const height = (canvas.height * width) / canvas.width;
                pdf.addImage(imgData, 'PNG', 0, 10, width, height);
                pdf.save("report.pdf");
            });
        }

        // === Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ===
        function getFormattedDateID(d) { return d.toISOString().split('T')[0]; }
        function getReadableDate(d) { return d.toLocaleDateString('ar-EG'); }
        function isToday(d) { return getFormattedDateID(d) === getFormattedDateID(new Date()); }

        function loadUserDataForDate(date) {
            const did = getFormattedDateID(date);
            document.getElementById('current-date-display').innerText = getReadableDate(date);
            if(unsubscribeSnapshot) unsubscribeSnapshot();
            
            unsubscribeSnapshot = db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did).onSnapshot(async doc => {
                if(doc.exists) {
                    lastUserData = doc.data();
                    renderMainUI(lastUserData);
                } else {
                    if(isToday(date)) {
                        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø«Ø¨Ø§Øª)
                        const root = await db.collection('users').doc(currentUser.uid).get();
                        // Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø£Ùˆ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                        const settings = root.data()?.habitSettings || DEFAULT_USER_DATA.habitSettings;
                        const templates = root.data()?.customAdhkarTemplates || [];
                        
                        const newData = { ...DEFAULT_USER_DATA, habitSettings: settings, customAdhkar: templates.map(t=>({name:t.name, target:t.target, count:0})) };
                        
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ÙŠÙˆÙ…
                        db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did).set(newData);
                    } else {
                        lastUserData = DEFAULT_USER_DATA;
                        renderMainUI(DEFAULT_USER_DATA);
                    }
                }
            });
        }

        function renderMainUI(data) {
            // 1. Ø§Ù„ØµÙ„ÙˆØ§Øª
            const pc = document.getElementById('tasks-container'); pc.innerHTML = '';
            const pMap = { fajr:'Ø§Ù„ÙØ¬Ø±', dhuhr:'Ø§Ù„Ø¸Ù‡Ø±', asr:'Ø§Ù„Ø¹ØµØ±', maghrib:'Ø§Ù„Ù…ØºØ±Ø¨', isha:'Ø§Ù„Ø¹Ø´Ø§Ø¡' };
            
            let html = `<div class="grid grid-cols-2 gap-3 mb-6">`;
            for(const [k, v] of Object.entries(data.prayers)) {
                html += `<div onclick="toggleTask('prayers','${k}',${!v})" class="bg-white p-3 rounded-xl border flex items-center justify-between cursor-pointer ${v?'border-green-500 bg-green-50':'border-gray-100'}">
                    <div><p class="font-bold text-sm ${v?'text-green-700':'text-gray-600'}">${pMap[k]}</p><p id="time-${k}" class="text-[10px] text-gray-400">--:--</p></div>
                    ${v ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-gray-300"></i>'}
                </div>`;
            }
            // Ù‚Ø±Ø¢Ù†
            const q = data.quran || false;
            html += `<div onclick="toggleTask('root','quran',${!q})" class="bg-white p-3 rounded-xl border flex items-center justify-between cursor-pointer ${q?'border-green-500 bg-green-50':'border-gray-100'}">
                <div><p class="font-bold text-sm ${q?'text-green-700':'text-gray-600'}">ÙˆØ±Ø¯ Ø§Ù„Ù‚Ø±Ø¢Ù†</p><span class="text-[10px] text-blue-500" onclick="event.stopPropagation(); openModal('quran-modal')">ğŸ“– Ù‚Ø±Ø§Ø¡Ø©</span></div>
                ${q ? '<i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>' : '<i data-lucide="circle" class="w-5 h-5 text-gray-300"></i>'}
            </div>`;
            html += `</div>`;
            
            // Ø§Ù„Ø³Ù†Ù† (Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
            html += `<h3 class="font-bold text-sm mb-3">Ø§Ù„Ø³Ù†Ù†</h3><div class="grid grid-cols-2 gap-3">`;
            const settings = data.habitSettings || DEFAULT_USER_DATA.habitSettings;
            for(const [k, meta] of Object.entries(HABITS_META)) {
                if(settings[k]) {
                    const v = data.habits[k] || false;
                    html += `<div onclick="toggleTask('habits','${k}',${!v})" class="bg-white p-3 rounded-xl border flex items-center gap-2 cursor-pointer ${v?'border-yellow-400 bg-yellow-50':'border-gray-100'}">
                        <i data-lucide="${meta.icon}" class="w-4 h-4 ${v?'text-yellow-600':'text-gray-400'}"></i>
                        <span class="text-xs font-bold ${v?'text-yellow-700':'text-gray-600'}">${meta.name}</span>
                    </div>`;
                }
            }
            html += `</div>`;
            pc.innerHTML = html;
            
            // Ø§Ù„Ø£Ø°ÙƒØ§Ø±
            const ac = document.getElementById('adhkar-container'); ac.innerHTML = '';
            let totalA = 0;
            (data.customAdhkar || []).forEach((a, i) => {
                totalA += a.count;
                const pct = Math.min((a.count/a.target)*100, 100);
                ac.innerHTML += `<div class="bg-white p-3 rounded-xl border border-gray-100 relative overflow-hidden">
                    <div class="flex justify-between items-center mb-2"><span class="text-xs font-bold truncate">${a.name}</span><button onclick="removeAdhkar(${i})" class="text-red-300"><i data-lucide="x" class="w-3 h-3"></i></button></div>
                    <div class="flex justify-between items-end relative z-10">
                        <div class="flex items-center gap-1"><span class="text-xl font-bold text-blue-600">${a.count}</span><button onclick="openManualCountModal(${i})" class="text-gray-300"><i data-lucide="edit-2" class="w-3 h-3"></i></button></div>
                        <button onclick="incrementAdhkar(${i})" class="w-8 h-8 bg-blue-600 text-white rounded-lg flex items-center justify-center click-anim"><i data-lucide="plus" class="w-4 h-4"></i></button>
                    </div>
                    <div class="absolute bottom-0 left-0 h-1 bg-blue-100 w-full"><div style="width:${pct}%" class="h-full bg-blue-500"></div></div>
                </div>`;
            });
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙÙŠ Ø¹Ù†ØµØ± Ù…Ø®ÙÙŠ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            const totalEl = document.getElementById('total-adhkar-count');
            if(!totalEl) { const s = document.createElement('span'); s.id='total-adhkar-count'; s.style.display='none'; document.body.appendChild(s); s.innerText=totalA; }
            else totalEl.innerText = totalA;
            
            updateDashboardStats(data);
            lucide.createIcons();
            updatePrayerUI();
        }

        function updateDashboardStats(data) {
            let tot=0, done=0;
            if(data.prayers) Object.values(data.prayers).forEach(v=>{tot++; if(v) done++});
            if(data.quran) { tot++; done++; }
            if(data.habits) {
                const s = data.habitSettings || {};
                for(const k in s) if(s[k]) { tot++; if(data.habits[k]) done++; }
            }
            const p = tot?Math.round((done/tot)*100):0;
            document.getElementById('chart-percent').innerText = p + '%';
            
            if(performanceChartInstance) performanceChartInstance.destroy();
            const ctx = document.getElementById('performanceChart');
            if(ctx) {
                performanceChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: { datasets: [{ data: [p, 100-p], backgroundColor: ['#047857', '#eee'], borderWidth: 0 }] },
                    options: { cutout: '75%', responsive: true, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
                });
            }
        }

        // === Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª ===
        function toggleTask(cat, k, v) {
            if(!isToday(currentDate)) return;
            const did = getFormattedDateID(currentDate);
            const up = {}; 
            if(cat==='root') up[k]=v; else up[`${cat}.${k}`]=v;
            db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did).update(up);
        }
        async function incrementAdhkar(i) {
            if(!isToday(currentDate)) return;
            const did = getFormattedDateID(currentDate);
            const ref = db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did);
            const doc = await ref.get();
            const list = doc.data().customAdhkar; list[i].count++;
            ref.update({ customAdhkar: list });
        }
        async function removeAdhkar(i) {
            if(!isToday(currentDate)) return;
            if(!confirm('Ø­Ø°ÙØŸ')) return;
            
            const root = db.collection('users').doc(currentUser.uid);
            const rd = await root.get();
            const t = rd.data().customAdhkarTemplates || [];
            if(t[i]) { t.splice(i,1); root.update({customAdhkarTemplates:t}); }
            
            const did = getFormattedDateID(currentDate);
            const ref = root.collection('daily_logs').doc(did);
            const d = await ref.get();
            const list = d.data().customAdhkar; list.splice(i,1);
            ref.update({ customAdhkar: list });
        }

        async function addNewDhikr() {
            const name = document.getElementById('new-dhikr-name').value;
            const target = parseInt(document.getElementById('new-dhikr-target').value);
            if(name && target) {
                const root = db.collection('users').doc(currentUser.uid);
                const rd = await root.get();
                const t = rd.data()?.customAdhkarTemplates || [];
                t.push({ name, target });
                await root.set({ customAdhkarTemplates: t }, { merge: true });
                
                if(isToday(currentDate)) {
                    const did = getFormattedDateID(currentDate);
                    const ref = root.collection('daily_logs').doc(did);
                    const doc = await ref.get();
                    const list = doc.data()?.customAdhkar || [];
                    list.push({ name, target, count: 0 });
                    await ref.update({ customAdhkar: list });
                }
                document.getElementById('new-dhikr-name').value = '';
                document.getElementById('new-dhikr-target').value = '';
                closeModal('adhkar-modal');
            }
        }

        // === Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø¨Ø§Ø¯Ø§Øª (Ø­ÙØ¸ Ø«Ø§Ø¨Øª) ===
        function openSettingsModal() { 
            if(!lastUserData) return; 
            const c = document.getElementById('settings-list'); c.innerHTML=''; 
            const s = lastUserData.habitSettings || {};
            for(const [k,m] of Object.entries(HABITS_META)) {
                c.innerHTML += `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg mb-2"><span class="text-sm font-bold">${m.name}</span><input type="checkbox" class="setting-toggle" data-key="${k}" ${s[k]?'checked':''}></div>`;
            }
            openModal('settings-modal'); 
        }

        async function saveSettings() {
            const toggles = document.querySelectorAll('.setting-toggle');
            const newSettings = {};
            toggles.forEach(t => newSettings[t.dataset.key] = t.checked);
            
            // 1. Ø­ÙØ¸ ÙÙŠ Ù…Ù„Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ù„ÙŠØ³ØªÙ…Ø± Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©)
            await db.collection('users').doc(currentUser.uid).set({ habitSettings: newSettings }, { merge: true });
            
            // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØºÙŠÙŠØ± ÙÙˆØ±Ø§Ù‹
            const did = getFormattedDateID(currentDate);
            await db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did).update({ habitSettings: newSettings });
            
            closeModal('settings-modal');
        }

        // === Ù…Ø³Ø§Ø¹Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ===
        function openManualCountModal(i) { currentAdhkarEditIndex=i; openModal('manual-count-modal'); }
        async function saveManualCount() {
            const val = parseInt(document.getElementById('manual-count-input').value);
            if(val && currentAdhkarEditIndex!==null) {
                const did = getFormattedDateID(currentDate);
                const ref = db.collection('users').doc(currentUser.uid).collection('daily_logs').doc(did);
                const doc = await ref.get();
                const list = doc.data().customAdhkar;
                list[currentAdhkarEditIndex].count += val;
                await ref.update({ customAdhkar: list });
            }
            closeModal('manual-count-modal');
        }

        function hideLoader() { const l=document.getElementById('loader'); if(l) l.style.display='none'; }
        function showScreen(id) { ['landing-screen','auth-screen','app-screen'].forEach(i=>document.getElementById(i).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function goToAuth(m){ showScreen('auth-screen'); if(m==='login'){ document.getElementById('login-form').classList.remove('hidden'); document.getElementById('register-form').classList.add('hidden'); } else { document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); } }
        function showLandingScreen(){ showScreen('landing-screen'); }
        function switchAuthMode(m) { 
            if(m==='reset') {
                document.getElementById('login-form').classList.add('hidden'); 
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('reset-form').classList.remove('hidden');
                return;
            }
            document.getElementById('reset-form').classList.add('hidden');
            goToAuth(m); 
            document.getElementById('tab-login').className = m==='login' ? "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-white text-[#047857] shadow-sm" : "flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all";
            document.getElementById('tab-register').className = m==='register' ? "flex-1 py-2.5 rounded-lg text-sm font-bold transition-all bg-white text-[#047857] shadow-sm" : "flex-1 py-2.5 rounded-lg text-sm font-bold text-gray-500 hover:text-gray-700 transition-all";
        }

        async function handleLogin(e){ e.preventDefault(); auth.signInWithEmailAndPassword(document.getElementById('login-email').value, document.getElementById('login-password').value).catch(e=>alert("Ø®Ø·Ø£: " + e.message)); }
        async function handleRegister(e){ e.preventDefault(); const n=document.getElementById('reg-name').value; auth.createUserWithEmailAndPassword(document.getElementById('reg-email').value, document.getElementById('reg-password').value).then(c=>c.user.updateProfile({displayName:n})).catch(e=>alert("Ø®Ø·Ø£: " + e.message)); }
        async function handleResetPassword(e) { e.preventDefault(); const em = document.getElementById('reset-email').value; auth.sendPasswordResetEmail(em).then(()=>alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©')).catch(e=>alert(e.message)); }

        function handleLogout(){ auth.signOut(); showLandingScreen(); }
        function changeDate(d) { const n = new Date(currentDate); n.setDate(n.getDate()+d); if(n>new Date()) return; currentDate=n; loadUserDataForDate(n); }
    </script>
</body>
</html>